<!--src/pages/admin/page/edit/[id].astro-->
---
// @ts-nocheck
const user = await Astro.session?.get('user')
if(!user){return Astro.redirect('/login')}

import Layout from "../../../../components/admin/Layout.astro"
import Page from "../../../../components/admin/Page-edit.svelte"
import pageDb from "../../../../models/page.js"
import setup from "../../../../settings.js"

let form = null

if(Astro.request.method === "POST"){
    form = {}
    const formData = await Astro.request.formData()
    const title = formData.get('title')
    const content = formData.get('content')
    const thumb = formData.get("thumb")
    const date = formData.get("datetime")

    const validate = (
        typeof title === 'string' && title !== '' &&
        typeof content === 'string' && content !== '' &&
        typeof thumb === 'string' && thumb !== '' &&
        typeof date === 'string' && date !== ''
    )

    if(validate){
        if(user.role === 'Admin'){
            const page = {title, content, thumb, date}
            await pageDb.updatePage(page, Astro.params)
            form.info = 'ការកែប្រែ​សំរេច​បាន​ដោយ​ជោគជ័យ!'
            form.success = true
        }else{
            form.info = 'អ្នក​គ្មាន​សិទ្ធិ​កែប្រែ​​ទំព័រ​ស្តាទិក​​ឡើយ!'
            form.success = false
        }
    }else{
        form.info = "ទិន្នន័យ​បញ្ជូន​មក​មិន​ត្រឹមត្រូវ​ទេ!"
        form.success = false
    }
}

const settings = await setup()
const params = Astro.url.searchParams
const navPage = params.get("p")
const page = await pageDb.getPage(Astro.params)
const items = await pageDb.paginatePages(parseInt(navPage), settings.dashboard)
const count = await pageDb.count()
const pageNumber = Math.ceil(count/settings.dashboard)

const data = { user, count, page, items, info:"ទំព័រ​ស្តាទិក", type:"page", pageNumber, form, navPage }
---
 
<Layout title="ទំព័រ​ស្តាទិក" data={data} >
    <Page slot="editor" {data} client:load />
</Layout>