<!--src/pages/admin/post/index.astro-->
---
// @ts-nocheck
const user = await Astro.session?.get('user')
if(!user){return Astro.redirect('/login')}

import Layout from "../../../components/admin/Layout.astro"
import Post from "../../../components/admin/Post.svelte"
import postDb from "../../../models/post.js"
import categoryDb from "../../../models/category.js"
import setup from "../../../settings.js"

let form = null

if(Astro.request.method === "POST"){
    form = {}
    const formData = await Astro.request.formData()
    const title = formData.get('title')
    const content = formData.get('content')
    const categories = formData.get('categories')
    const thumb = formData.get("thumb")
    const datetime = formData.get("datetime")
    const videos = formData.get("videos")

    const validate = (
        typeof title === 'string' && title !== '' &&
        typeof content === 'string' &&
        typeof categories === 'string' && categories !== '' &&
        typeof thumb === 'string' && thumb !== '' &&
        typeof datetime === 'string' && datetime !== '' &&
        typeof videos === 'string'
    )

    if(validate){
        const post = {title, content, categories, thumb, datetime, videos}
        await postDb.createPost(post, user)
        form.info = 'ការផ្សាយ​មួយ​ត្រូវ​បាន​បង្កើត​ឡើង!'
        form.success = true
    }else{
        form.info = "ទិន្នន័យ​បញ្ជូន​មក​មិន​ត្រឹមត្រូវ​ទេ!"
        form.success = false
    }
}

const settings = await setup()
const items = await postDb.getPosts(settings.dashboard)
const count = await postDb.count()
const pageNumber = Math.ceil(count/settings.dashboard)
const categories = await categoryDb.getAllItems()

const data = { user, count, settings, items, categories, info:"ការផ្សាយ", type:"post", pageNumber, form }
const formCookie = Astro.cookies.get('form')
if(formCookie){
    data.form = JSON.parse(formCookie.value)
    Astro.cookies.delete("form", { path: '/' })
}
---
 
<Layout title="ទំព័រ​ការផ្សាយ" data={data} >
    <Post slot="editor" {data} client:load />
</Layout>